# 硬件加速中的“层”和层叠上下文中的“层”，是一个东西吗
**页面渲染的流程**
初次渲染时会经过以下几步:  
1. 构建DOM树；
2. 样式计算；
3. 布局定位；
4. 图层分层；
5. 图层绘制；
6. 合成显示；

在CSS属性改变时，重渲染会分为“回流”、“重绘”和“直接合成”三种情况，分别对应从“布局定位”/“图层绘制”/“合成显示”开始，再走一遍上面的流程。  
CSS具体发生什么改变，则决定属于上面哪种情况：  
1. 回流（又叫重排）：元素位置、大小发生变化导致其他节点联动，需要重新计算布局；
2. 重绘：修改了一些不影响布局的属性，比如颜色；
3. 直接合成：合成层的transform、opacity修改，只需要将多个图层再次合并，而后生成位图，最终展示到屏幕上；

浏览器中的层分为两种：“渲染层”和“合成层（也叫复合层）”。 

## 渲染层 
拥有z-index属性的定位元素会生成一个层叠上下文，一个生成层叠上下文的元素就生成了一个渲染层  
形成渲染层的条件也就是形成层叠上下文的条件，有这几种情况：  
1. document 元素
2. 拥有z-index属性的定位元素（position: relative|fixed|sticky|absolute）
3. 弹性布局的子项（父元素display:flex|inline-flex)，并且z-index不是auto时
4. opacity非1的元素
5. transform非none的元素
6. filter非none的元素
7. will-change = opacity | transform | filter

## 合成层
只有一些特殊的渲染层才会被提升为合成层，通常来说有这些情况：  
1. transform:3D变换：translate3d，translateZ；
2. will-change:opacity | transform | filter
3. 对 opacity | transform | fliter 应用了过渡和动画（transition/animation）
4. video、canvas、iframe

隐式合成  
当出现一个合成层后，层级顺序高于它的堆叠元素就会发生隐式合成。
给C、D元素设置层级，z-index分别是3和4；又在C元素上使用3D变换，提升成了合成层。此时，层级高于它的D元素就发生了隐式合成，也变成了一个合成层。  
隐式合成出现的根本原是，元素发生了堆叠，浏览器为了保证最后的展示效果，不得不把层级顺序更高的元素拎出来盖在已有合成层上面  
**层爆炸与层压缩**  
一个页面在低端机器上滚动时非常卡顿，排查了很久，最后发现原因就在于隐式合成带来的层爆炸  
隐式合成产生了很多预期外的合成层——页面中所有 z-index 高于它的节点全部被提升，这些合成层都是相当消耗内存和GPU的。所以带给我们的启示是给合成层一个大的z-index值，避免出现隐式合成。  
还好浏览器逐渐进行了优化，也就是层压缩机制——多个渲染层同一个合成层重叠时，会自动将他们压缩到一起，避免“层爆炸”带来的损耗。  
## 硬件加速
浏览器为什么要分层呢？答案是硬件加速。听起来很厉害，其实不过是给HTML元素加上某些CSS属性，比如3D变换，将其提升成一个合成层，独立渲染。  
之所以叫硬件加速，就是因为合成层会交给GPU（显卡）去处理，在硬件层面上开外挂，比在主线程（CPU）上效率更高  
就像在ipad上画画一样，画手都是在不同的图层绘制线稿、上色，这样才方便后期修改，不至于牵一发而动全身。提升成合成层的元素发生回流、重绘都只影响这一层，渲染效率得到提升。  
使用animation改变B元素的宽度，通过开发者工具Layers中的“paint count”的可以看到页面绘制次数会一直在增加，能直观感受到页面发生了“重绘”  
重绘是发生在整个图层#document上的，也就是整个页面都要重绘。  
发现重绘只发生在这个图层上，#document图层的绘制次数不会一直增加了  
在讲到性能优化时，经常会说减少回流、重绘，如果能直接避免当然是最好，但如果实在没法避免，可以使用硬件加速，让这个元素单独回流、重绘，减少绘制的面积。  
开启硬件加速后的合成层会交给GPU处理，当图层过多时，将会占用大量内存，尤其在移动端会造成卡顿，让优化适得其反。正确使用硬件加速就是在渲染效率和性能损耗之间找到一个平衡点，让页面渲染迅速不白屏，又流畅丝滑。  
## 优化渲染性能
利用硬件加速，可以把需要重排/重绘的元素单独拎出来，减少绘制的面积，除此之外，提升渲染性能还有这几个常见的方法：  
1. 避免重排/重绘，直接进行合成，合成层的transform 和 opacity的修改都是直接进入合成阶段的；比如可以使用transform:translate代替left/top修改元素的位置；使用transform:scale代替宽度、高度的修改；
2. 注意隐式合成，给合成层一个较大的z-index值，虽然大部分浏览器已经实现了层压缩的能力，但是依旧有无法处理的情况，最好的办法就是一开始就避免层爆炸；
3. 减小合成层占用的内存，合成层的最大问题就是占用内存较多，而内存的占用和元素的尺寸是成正比的，如果要实现一个100X100的元素，可以给宽高都设置为10px，再使用transform:scale(10)放大10倍，这样占用的内存只有直接设置的1/100；

## 总结
1. 硬件加速并不是前端专有的东西，它是一个很宽泛的计算机概念——把软件的工作交给特定的硬件，更高效的完成某项任务。对于前端来说，就是使用特定的CSS属性，把元素提升成合成层，交给GPU处理；
2. 合成层中的“层”可以被认为是真正物理上的层，浏览器把它独立出来，单独拿给GPU处理，而层叠上下文的“层”则是指渲染层，更像是一个概念上的层，一个合成层可以包含多个渲染层；
3. 层爆炸指的是大量元素意料之外被提升成合成层，即隐式合成；层压缩是浏览器对隐式合成的优化，chrome在94版本中做到比较完善了；
4. 使用transform、opacity取代传统属性来实现一些动画，并把他们提升到一个单独的合成层，能跳过布局计算和重新绘制，直接合成，能避免不必要的回流、重绘；

原文: 
[抖音三面：硬件加速中的“层”和层叠上下文中的“层”，是一个东西吗？](https://mp.weixin.qq.com/s/xuWgEMh9Y8Eq_Go2uBH24g)
