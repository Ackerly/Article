# React组件的受控与非受控
**什么是受控组件？什么又是非受控组件？**  
Input 组件有一个内部的状态（State）value，而且它没有任何属性，因此很显然，它是一个非受控的组件，它的组件状态并不受外部环境控制，而是封闭在组件内部。  
如果稍微对它做一点调整，把原本的内部状态 value 去掉，放到 props 上去，它就变成了受控组件很显然，此时输入框的值是取决于外部传递进来的 props   
**既受控组件又非受控**  
对于组件库来说，有非常多的组件需要做到既支持受控模式，又支持非受控模式。以 antd-mobile 现在的 5.17 版本为例，几乎全部的涉及到输入值、切换、展开收起的组件，都是需要做到既受控又非受控的。  

## 如何实现
**最简单的方案：内外两个状态，手动同步**  
考虑到实现成本的复杂度，需要让组件逻辑在两种模式下，尽可能的保持一致，减少逻辑分支意味着更好的可维护性和可读性。  
Child 组件内部始终存在一个状态，不管它处于哪种模式，它都直接使用自己内部的状态。而当它处于受控模式时，让它的内部状态和 Parent 组件中的状态手动保持同步。  
受控模式下存在两个问题：  
- 原子性：Child 内部状态的更新会比 Parent 组件晚一个渲染周期，存在 tearing 的问题
- 性能：因为是在 useEffect 中通过 setState 来做的状态同步，所以会额外的触发一次渲染，存在性能问题

**解决问题 1：原子性**  
其实并不需要 Child 和 Parent 的状态保持非常严格的每时每刻都一致，只需要判断，如果组件此时处于受控模式，那么直接使用来自外部的状态就可以了.这样，即便状态的同步是存在延迟的，但是 Child 组件所真正使用到的值一定是最新的   
**解决问题 2：性能**  
因为是在 useEffect 去做状态同步,所以自然会额外的多触发一次 Child 组件的重渲染。如果 Child 组件比较简单的话，那出现的性能影响可以忽略不计。但是对于一些复杂的组件（例如 Picker），多渲染一次带来的性能问题是比较严重的。  
那有没有办法在 Child 组件的 render 阶段就直接更新 value 状态呢？并不可以，React 不允许我们在 render 过程中调用 setState。  
当我们创建这个 State 时？我们的目的是什么？State 的本质是什么？  
如果比较简单粗暴的分析，可以把 State 拆成两部分：  
- State 是用来存放数据的，它让我们在组件的渲染函数之外，可以 “持久化” 一些数据
- State 的更新可以触发重新渲染，因为 React 会感知 State 的更新

State = 存放数据 + 触发重新渲染  
就存放数据来看，可以直接使用 Ref；同样，如果只是需要触发重新渲染，可以使用类似于 setFlag({}) 或者 setCount(v => v + 1) 这样的强制方式  
据这个推断来调整一下上面的公式：  
```
State = Ref + forceUpdate()
```
根据这个公式，我们可以把 Child 组件中的 State 拆成一个 Ref 和一个 forceUpdate 函数  
为什么还需要判断根据受控和非受控模式来使用不同的值呢？  
既然 stateRef.current 一定是最新的值，那么完全可以简化成 Child 组件永远使用内部存放的数据（Ref）  
除此之外，还可以把手动实现的 forceUpdate 替换成 ahooks 的 useUpdate  

**抽象与复用：usePropsValue**  
已经基本实现了所有的功能,但我们只是实现了一个 Input 组件，在 antd-mobile 这样的组件库中，会有很多很多组件都需要支持能够切换受控和非受控模式。所以，为了更好的可复用性，把上面的逻辑抽离成一个自定义 Hook  
这样，在各种组件中，我们可以直接使用 usePropsValue，用法和 useState 非常接近  
不过，我们忽略了 defaultValue，在 antd-mobile 中，value onChange defaultValue 总是成组出现的  
接下来，让对它再做一点优化，让它变得更像 useState。useState 得到的 setState 函数，支持传入一个更新函数，而 usePropsValue 目前还不支持这种用法  

**一个隐藏的小 bug**  
假如当前的 state 为 1，如果我们用的是 React 的 useState，那执行 setState (1) 不会有任何效果，React 会帮我们过滤掉这次的更新。而 usePropsValue 不会  
对用户来说，点击同一个 Tab 并没有触发切换，也因此不应该触发 onChange 事件



原文:  
[React组件的受控与非受控](https://mp.weixin.qq.com/s/0yq5fHId76ErPYb6z2eaxw)