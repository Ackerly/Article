# AVIF图片格式在bilibili落地
图片库加载服务是为 bilibili 打造的移动端一站式解决方案，集图像加载、显示、处理、监控于一体，以高可用、高性能、可高度定制、数据服务、省流量五大核心优势被公司各个业务接入使用，经过长期的迭代与维护，已成熟稳定。  
在如今越来越看重体验的大环境下，对图片库的要求也日益攀升。从成本的角度来看，使用 AVIF 格式可以节省大量的网络带宽和存储空间，减少网站加载时间，并且可以改善用户体验，进而提高网站的效率和收益，从而节约大量的费用。  
AVIF 格式能够带来许多优势，首先，AVIF 格式具有明显的压缩率优势，可以比其他常用图片格式（如 JPEG、PNG）节省更多的存储空间，减少图片加载所需时间和带宽，提高网站加载速度，提高访问者的体验；其次，AVIF 格式丰富的特性支持，可以支持更多的设备和浏览器，提高图片的可用性，并可以免专利费的优势；最后，AVIF 格式支持图片的质量优化，可以保证图片的质量，同时节省更多的容量。  

## AVIF 图片格式研究
**1. 图片格式编解码研究**  
图片格式 AVIF 编解码详解进行 AVIF 图片格式的研究，AVIF 格式相比其他图片格式，有着更高的压缩比，可以支持更多的色彩深度，支持 alpha 通道，支持更多的图片尺寸，支持动态图片，支持更多的压缩选项，可以更有效地利用计算资源，支持多层编码，支持非码率压缩，支持虚拟化和硬件加速，支持缩略图和视频帧等。  

**2. AVIF 在 B 站落地的调研**  
2022 年以前，B 站主流图片格式为 WebP，在对基础设施成本做回顾的过程中，定位到静态资源 CDN 成本是重要的组成部分。随着业界技术的逐渐成熟，经过相关调研，认为 AVIF 在 B 站大规模落地存在可行性。  
在相同格式相同编码器下，可以简单的认为编码速度、图像质量与图片体积构成一个不可能三角，需要通过调整编码速度参数（下称 speed）与图像质量参数（下称 quality），在三者之间做取舍。  
选取了三百万线上真实的缩略图请求，于实验环境进行回放，尽可能贴近 B 站实际使用场景。对同一个缩略请求，使用线上现有编码参数，生成 PNG 和 WebP 两个版本，并用几个不同档位的 speed 和 quality，生成若干个 AVIF 版本，其中 PNG 被认为是无损格式，用作比较基准。  
PSNR 可以被用于衡量原图与编码后图片的差异大小，一般大于 30 dB 即可认为人眼较难察觉出图像差异，大于 20 dB 被认为人眼观感差异不明显。PSNR 不能代替人类主观评价，但定量实验中，需要一个客观指标。无特别描述的前提下，下文提及 WebP/AVIF 的图像质量时，指的是 PSNR (PNG → WebP) 和 PSNR ( PNG → AVIF ) 的数值大小。  
经过持续数天的流量回放实验，有以下定性结论：  
- speed 对编码耗时影响显著，对图像质量与图片体积影响不大
- 相同 speed/quality 的前提下，图片越大，AVIF 相对 WebP 的体积优势越明显
- 相同 speed / 图片大小 的前提下，质量 (quality) 越高，AVIF 相对 WebP 的体积优势越明显

原文:  
[AVIF图片格式在bilibili落地](https://mp.weixin.qq.com/s/kXxMGICkF2MEwul5s2_UQg)
