# 可视化搭建 - 组件值与联动
组件联动是指几个组件相互关联。也就是当一个组件状态变化时，其他组件可以响应。  
组件联动是多对多关系的，且目的分为一次性与持续性：  
- 多对多关系：即一个组件可以同时被多个组件联动；多个组件可以同时联动一个组件。
- 一次性与持续性：一次性事件可以被覆盖，持续性事件会同时生效，且要考虑叠加关系。

一定程度上，持续性事件可以覆盖一次性事件的场景：组件永远响应最后一个过来的事件即可。  

## 组件值
每个组件实例都有一个唯一的组件值。可以通过 getValue(componentId) 与 setValue(componentId, value) 访问或更新组件值：  
``` 
const table = {
  componentName: "table",
  runtimeProps: ({ componentId, setValue }) => ({
    // 给组件注入 onChange 函数，在其触发时更新当前组件实例的组件值
    onChange: (value) => setValue(componentId, value),
  }),
};
```
也可以通过 componentMeta.value 声明组件值，比如下面的例子，让组件值与 props.value 同步：  
``` 
const table = {
  componentName: "table",
  // 声明 value 的值为组件 props.value 的返回值，并随着组件 props.value 的更新而更新
  value: ({ selector }) => selector(({ props }) => props.value),
};
```
**为什么一个组件实例只有一个组件值？**  
一个组件可能同时拥有多个状态，比如该组件内部有一个输入框，还有一个按钮，可能输入框的值，与按钮的点击状态都会对其他组件产生联动效果。但这并不意味着一个组件实例需要多个组件值，我们可以将组件值定义为对象，并合理规划不同的 key 描述不同维度的值：  
``` 
// 组件值结构
{
  // 组件内输入框的值
  text: '123',
  // 组件内按钮被按下的次数
  buttonClickTimes: false
}
```
**为什么不用 props.value 代替组件值？**  
理论上可以，但这样限定了组件对 props 的定义。也许有的组件用 props.value 描述输入框的值，但也有比如 Check 组件，用 props.checked 表示当前选中状态。只有抽象一个定义与组件元信息的规则，让业务自由对接，才可以让组件值适配任意类型的组件。  

## 值联动
有了组件值这个概念，就可以以组件实例为粒度，设计组件的关联关系了。  
为了让组件关联更加灵活，我们的设计需要满足以下几种能力：  
1. 联动关系支持多对多。
2. 可以随着全局数据状态变化，或者组件自身 props 变化，随时改变组件关联关系。
3. 一个组件可以定义其他几个组件的关联关系，哪怕自己不参与到联动关系链中。
4. 当组件实例被删除时，由它定义的联动关系立刻失效。

我们采用 componentMeta.valueRelates 声明式定义值联动关系：  
``` 
const table = {
  componentName: "table",
  valueRelates: ({ componentId, selector }) => {
    return [
      {
        sourceComponentId: componentId, // 自己为触发源
        targetComponentId: selector(({ props }) => props.targetComponentId), // 目标组件 ID 为 props.targetComponentId
      },
    ];
  },
};
```


原文:  
[可视化搭建 - 组件值与联动](https://mp.weixin.qq.com/s/CUMyfAqRQWx5l8cLgCMRfA)
